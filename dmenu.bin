#!/bin/bash

# Setup the environment variables
export PATH=/bin:/sbin:$PATH
export LD_LIBRARY_PATH=/usr/lib:/mnt/vendor/lib

# The boot partition mount point a
BOOT_PARTITION_MOUNT_POINT=/boot

# The boot partition mount point b
BOOT_PARTITION_MOUNT_POINT_B=/boot2

# The partition we wish to boot from
BOOT_PARTITION=/dev/mmcblk1p1

# The init script we're hoping to execute instead of stock OS
INIT_FILE=boot/init

# The rom image from GARLIC OS
ROM_FILE=boot/rootfs.f2fs

# Force to start a specific OS source
OS_1=TF2
OS_2=Stock
OS_3=TF1

function os_tf2
{
	# Check for a MicroSD card in the TF2 slot
	if [ -b /dev/mmcblk1p1 ]
	then
		# Mount the boot partition
		mkdir $BOOT_PARTITION_MOUNT_POINT
		mount -t exfat $BOOT_PARTITION $BOOT_PARTITION_MOUNT_POINT

		# The partition contains a init script
		if [ -f $BOOT_PARTITION_MOUNT_POINT/$INIT_FILE ]
		then
			# Run the deviceinfo script (sets necessary, device-specific environment variables)
			source /mnt/mmc/device-resources/deviceinfo

			# Execute the init script (this one should never return)
			/bin/bash $BOOT_PARTITION_MOUNT_POINT/$INIT_FILE

			# Sync data to disk
			sync

			# Power the device off
			echo o > /proc/sysrq-trigger
		else
			# Unmount the boot partition
			if [ -f $BOOT_PARTITION_MOUNT_POINT/$ROM_FILE ]
			then
				umount $BOOT_PARTITION_MOUNT_POINT
				rmdir $BOOT_PARTITION_MOUNT_POINT
			else
				umount $BOOT_PARTITION_MOUNT_POINT
			fi
		fi
	fi
	os_stock
}

function os_stock
{
	# Start Stock OS
	exec /mnt/vendor/bin/dmenu.bin
}

function os_tf1
{
	if [ -d $BOOT_PARTITION_MOUNT_POINT_B ]
	then
		# Create a symlink from /boot to /boot2
		ln -sf $BOOT_PARTITION_MOUNT_POINT_B $BOOT_PARTITION_MOUNT_POINT
		
		# The partition contains a init script
		if [ -f $BOOT_PARTITION_MOUNT_POINT/$INIT_FILE ]
		then
			# Run the deviceinfo script (sets necessary, device-specific environment variables)
			source /mnt/mmc/device-resources/deviceinfo

			# Execute the init script (this one should never return)
			/bin/bash $BOOT_PARTITION_MOUNT_POINT/$INIT_FILE

			# Sync data to disk
			sync

			# Power the device off
			echo o > /proc/sysrq-trigger
		else
			# Delete the symlink
			unlink $BOOT_PARTITION_MOUNT_POINT
		fi
	fi
	os_tf2
}

if [ -f /$OS_1 ]
then
	os_tf2
elif [ -f /$OS_2 ]
	os_stock
elif [ -f /$OS_3 ]
	os_tf1
else
	os_tf1
fi
